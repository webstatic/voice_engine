const path = require("path");
const sqlite3 = require("sqlite3").verbose();

let db;

module.exports = function (cb) {
  const dbPath = path.resolve(__dirname, "../data/kanjidb.sqlite");
  db = new sqlite3.Database(dbPath, sqlite3.OPEN_READONLY, function (err) {
    cb(err, { search, searchSentence });
  });

  // process.on("SIGTERM", () => db.close((err) => process.exit(err ? 1 : 0)));
};

function search(kanji, cb) {
  doSearch(
    `SELECT *
    FROM elements AS E
    JOIN kanjidict AS K ON E.kanji = K.kanji
    WHERE E.kanji = '${kanji}'`,
    cb
  );
}

function searchSentence(kanji, cb) {
  doSearch(
    `SELECT *
    FROM sentences
    WHERE kanji LIKE '%${kanji}%';`,
    cb
  );
}

function doSearch(query, cb) {
  db.all(query, cb);
}
